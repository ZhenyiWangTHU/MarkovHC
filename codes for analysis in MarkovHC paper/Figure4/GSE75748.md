```R
library(Rtsne)
library(ggplot2)
library(MarkovHC)
library(stringr)
library(Seurat)
library(reticulate)
library(ggalluvial)
library(plyr)
library(pheatmap)
library(car)
library(dplyr)
library(phateR)
library(clusterProfiler)
library(org.Mm.eg.db)
library(stringr)
library(ggraph)
options(stringsAsFactors = F)
data <- read.csv(file = "./GSE75748/GSE75748_sc_cell_type_ec.csv",
                 header = T,
                 row.names = 1)
genelist <- read.table(file = "./GSE75748/13059_2016_1033_MOESM2_ESM.txt", header = T)
celltypeconvert <- read.csv(file = './GSE75748/celltypeconvert.csv', header = F)
reallabel <- colnames(data)%>%as.data.frame()
colnames(reallabel) <- 'V1'
for (i in 1:nrow(reallabel)) {
  reallabel[i,1] <- str_split(reallabel[i,1], '_')[[1]][1]
}
reallabel <- merge(reallabel, celltypeconvert, by = 'V1', sort = FALSE)
data <- round(data, digits = 0)
#data <- subset(data, rownames(data)%in%genelist[,1])

#Seurat
GSE75748object <- CreateSeuratObject(counts = data,
                                     project = 'GSE75748',
                                     min.cells = 10,
                                     min.feature = 200)
GSE75748object[["percent.mt"]] <- PercentageFeatureSet(GSE75748object, pattern = "^MT-")
VlnPlot(GSE75748object, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
GSE75748objectplot1 <- FeatureScatter(GSE75748object, feature1 = "nCount_RNA", feature2 = "percent.mt")
GSE75748objectplot2 <- FeatureScatter(GSE75748object, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
CombinePlots(plots = list(GSE75748objectplot1, GSE75748objectplot2))

GSE75748object <- NormalizeData(GSE75748object, normalization.method = "LogNormalize", scale.factor = 10000)

GSE75748object <- FindVariableFeatures(GSE75748object, selection.method = "vst", nfeatures = 3000)
# Identify the 10 most highly variable genes
GSE75748objecttop10 <- head(VariableFeatures(GSE75748object), 10)
# plot variable features with and without labels
GSE75748objectplot1 <- VariableFeaturePlot(GSE75748object)
GSE75748objectplot2 <- LabelPoints(plot = GSE75748objectplot1, points = GSE75748objecttop10, repel = TRUE)
GSE75748objectplot2
GSE75748object <- ScaleData(GSE75748object, features = rownames(GSE75748object))
GSE75748object <- RunPCA(GSE75748object, features = VariableFeatures(object = GSE75748object), verbose=FALSE)

ElbowPlot(GSE75748object, ndims = 50)

GSE75748object <- RunTSNE(object = GSE75748object, dims=1:20)
GSE75748object <- RunUMAP(object = GSE75748object, dims=1:20, n.neighbors=50)
DimPlot(GSE75748object, reduction = "tsne")
DimPlot(GSE75748object, reduction = "pca")
DimPlot(GSE75748object, reduction = "umap")
GSE75748object@meta.data$cellTypes <- reallabel[,2]
colorvector <- c( "H1 ES cell"="#66c2a5",
                  "H9 ES cell" ="#fc8d62",
                  "definitive endoderm cell"="#8da0cb",
                  "endothelial cell"="#e78ac3",
                  "human foreskin fibroblast"="#a6d854",
                  "neuronal progenitor cell"="#ffd92f",
                  "trophoblast-like cell"="#1f78b4")

DimPlot(GSE75748object,dims=c(1,2), reduction = "pca",group.by='cellTypes', 
        cols = colorvector, 
        pt.size=2,
        label = T,
        label.size = 6)

phate.GSE75748object <- phate(subset(GetAssayData(object = GSE75748object, slot = "scale.data"),
                                     rownames(GetAssayData(object = GSE75748object, slot = "scale.data"))%in%GSE75748object@assays$RNA@var.features)%>%t(),
                              knn = 50,
                              npca=20,
                              t=5)

plot(phate.GSE75748object$embedding)

#PCA_result <- prcomp(t(data), scale = TRUE)
#plot(PCA_result$x[,c(1,2)])
#scatter3d(PCA_result$x[,1],PCA_result$x[,2],PCA_result$x[,3], point.col = "black", surface=FALSE)

#Figures
mytheme <-  theme(panel.grid.major =element_blank(),
                  panel.grid.minor = element_blank(),
                  panel.background = element_blank(),
                  axis.line = element_line(size = 1,
                                           colour = "black"),
                  axis.title.x =element_text(size=20,
                                             family = "sans",
                                             color = "black",
                                             face = "bold"),
                  axis.text.x = element_text(size = 20,
                                             family = "sans",
                                             color = "black",
                                             face = "bold",
                                             vjust = 0,
                                             hjust = 0),
                  axis.text.y = element_text(size = 20,
                                             family = "sans",
                                             color = "black",
                                             face = "bold",
                                             vjust = 0,
                                             hjust = 1),
                  axis.title.y=element_text(size=20,
                                            family = "sans",
                                            color = "black",
                                            face = "bold"),
                  legend.text = element_text(size=15,
                                             family = "sans",
                                             color = "black",
                                             face = "bold"),
                  legend.title = element_text(size=15,
                                              family = "sans",
                                              color = "black",
                                              face = "bold"),
                  legend.background = element_blank(),
                  legend.key=element_blank(),
                  plot.title=element_text(family="sans",size=15,color="black",
                                          face="bold",hjust=0.5,lineheight=0.5,vjust=0.5))
#TSNE
data <- subset(data, rownames(data)%in%VariableFeatures(object = GSE75748object))
test <- umap(t(data))
plot(test$Y)
test <- umap::umap(t(data))
plot(test$Y)
layout <- as.data.frame(test$Y)
pdf(file = './test.pdf', width = 3.5, height = 3.5)
ggplot(data=layout, mapping =  aes(x=V1, y=V2)) +
  geom_point(size=1, shape=21, aes(fill=cellTypes), color=alpha("#525252",0))+
  geom_point(data=EScells,size=1, shape=21, aes(x=V1, y=V2, fill=cellTypes), color=alpha("#525252",0))+
  #xlim(min(layout$V1)-1,max(layout$V1)+1)+
  #ylim(min(layout$V2)-1,max(layout$V2)+1)+
  mytheme+ggtitle("ground truth")+ guides(fill=FALSE)+
  xlab("V1") + ylab("V2")+
  scale_fill_manual(
    values =c( "H1 ES cell"=alpha("#7E6148FF",0.7),
               "H9 ES cell"=alpha("#7E6148FF",0.7),
               "definitive endoderm cell"=alpha("#4DBBD5FF",0.7),
               "endothelial cell"=alpha("#F39B7FFF",0.7),
               "human foreskin fibroblast"=alpha("#DC0000FF",0.7),
               "neuronal progenitor cell"=alpha("#08519c",0.7),
               "trophoblast-like cell"=alpha("#00A087FF",0.7)),
    breaks = c("H1 ES cell",
               "H9 ES cell",
               "definitive endoderm cell",
               "endothelial cell",
               "human foreskin fibroblast",
               "neuronal progenitor cell",
               'trophoblast-like cell'))
dev.off()

#layout <- as.data.frame(TSNE_result$Y)
layout <- phate.GSE75748object$embedding%>%as.data.frame()
layout$cellTypes <- GSE75748object@meta.data$cellTypes
EScells <- subset(layout, layout$cellTypes%in%c("H1 ES cell","H9 ES cell"))
layout <- layout[-which(layout$cellTypes%in%c("H1 ES cell","H9 ES cell")),]
pdf(file = './CelltypesWithLegend.pdf', width = 3.5, height = 3.5)
ggplot(data=layout, mapping =  aes(x=PHATE1, y=PHATE2)) +
  geom_point(size=1, shape=21, aes(fill=cellTypes), color=alpha("#525252",0))+
  geom_point(data=EScells,size=1, shape=21, aes(x=PHATE1, y=PHATE2, fill=cellTypes), color=alpha("#525252",0))+
  #xlim(min(layout$V1)-1,max(layout$V1)+1)+
  #ylim(min(layout$V2)-1,max(layout$V2)+1)+
  mytheme+ggtitle("ground truth")+ #guides(fill=FALSE)+
  xlab("PHATE1") + ylab("PHATE2")+
  scale_fill_manual(
    values =c( "H1 ES cell"=alpha("#7E6148FF",0.7),
               "H9 ES cell"=alpha("#7E6148FF",0.7),
               "definitive endoderm cell"=alpha("#4DBBD5FF",0.7),
               "endothelial cell"=alpha("#F39B7FFF",0.7),
               "human foreskin fibroblast"=alpha("#DC0000FF",0.7),
               "neuronal progenitor cell"=alpha("#08519c",0.7),
               "trophoblast-like cell"=alpha("#00A087FF",0.7)),
    breaks = c("H1 ES cell",
               "H9 ES cell",
               "definitive endoderm cell",
               "endothelial cell",
               "human foreskin fibroblast",
               "neuronal progenitor cell",
               'trophoblast-like cell'))

dev.off()

#MarkovHC
MarkovHC_GSE75748 <- MarkovHC(origin_matrix=Embeddings(object = GSE75748object, reduction = "pca")[,1:20]%>%t(),
                               transformtype="none",
                               KNN=50,
                               basecluster="kmeans",
                               dobasecluster=TRUE,
                               baseclusternum=200,
                               emphasizedistance=1,
                               weightDist=2,
                               weightDens=0.5,
                               cutpoint=0.01,
                               showprocess=FALSE,
                               bn=2,
                               minBasinSize=0.2,
                               noiseBasinSize=20)


sankeyResult_GSE75748 <- sankeyResult(MarkovObject = MarkovHC_GSE75748,
                                       MarkovLevels = 40:43)
for (i in 1:ncol(sankeyResult_GSE75748)) {
  sankeyResult_GSE75748[,i] <- paste(colnames(sankeyResult_GSE75748)[i],
                                     sankeyResult_GSE75748[,i],
                                     sep = '_basin')
}
sankeyResult_GSE75748$Freq <- rep(1,nrow(sankeyResult_GSE75748))

head(sankeyResult_GSE75748)
#layout <- as.data.frame(TSNE_result$Y)
layout <- phate.GSE75748object$embedding%>%as.data.frame()
basins <- character(length = ncol(data))
for (i in 1:length(basins)) {
  indexi <- subset(sankeyResult_GSE75748,sankeyResult_GSE75748[,1]==paste('index_basin',i,sep = ""))
  basins[i] <- paste(unique(indexi[,2])%>%sort(), collapse = '+')
}
# level <- 40
# for (i in 1:length(MarkovHC_GSE75748$hierarchicalStructure[[level]]$attractorPoints)) {
#   basins[MarkovHC_GSE75748$hierarchicalStructure[[level]]$attractorPoints[[i]]] <- "attractors"
# }
layout$basins <- basins
pdf(file = './level40.pdf', width = 3.5, height = 3.5)
ggplot(data=layout, mapping =  aes(x=PHATE1, y=PHATE2)) +
  geom_point(size=1, shape=21, aes(fill=basins), color=alpha("#525252",0))+
  xlim(min(layout$PHATE1)-1,max(layout$PHATE1)+1)+
  ylim(min(layout$PHATE2)-1,max(layout$PHATE2)+1)+
  mytheme+ggtitle("level 40")+ guides(fill=FALSE)+
  xlab("PHATE1") + ylab("PHATE2")+
  scale_fill_manual(
    values = c("level40_basin1"=alpha("#9ecae1",0.7),
               "level40_basin2"=alpha("#DC0000FF",0.7),
               "level40_basin3"=alpha("#4DBBD5FF",0.7),
               "level40_basin4"=alpha("#00A087FF",0.7),
               "level40_basin5"=alpha("#08519c",0.7),
               "level40_basin6"=alpha("#7E6148FF",0.7),
               "level40_basin7"=alpha("#C6A87F",0.7),
               "level40_basin8"=alpha("#F39B7FFF",0.7)),
    breaks = c("level40_basin1",
               "level40_basin2",
               "level40_basin3",
               "level40_basin4",
               "level40_basin5",
               "level40_basin6",
               "level40_basin7",
               "level40_basin8"))

dev.off()

#level41
#layout <- as.data.frame(TSNE_result$Y)
layout <- phate.GSE75748object$embedding%>%as.data.frame()
basins <- character(length = ncol(data))
for (i in 1:length(basins)) {
  indexi <- subset(sankeyResult_GSE75748,sankeyResult_GSE75748[,1]==paste('index_basin',i,sep = ""))
  basins[i] <- paste(unique(indexi[,3])%>%sort(), collapse = '+')
}
layout$basins <- basins
pdf(file = './level41.pdf', width = 3.5, height = 3.5)
ggplot(data=layout, mapping =  aes(x=PHATE1, y=PHATE2)) +
  geom_point(size=1, shape=21, aes(fill=basins), color=alpha("#525252",0))+
  xlim(min(layout$PHATE1)-1,max(layout$PHATE1)+1)+
  ylim(min(layout$PHATE2)-1,max(layout$PHATE2)+1)+
  mytheme+ggtitle("level 41")+guides(fill=FALSE)+
  xlab("PHATE1") + ylab("PHATE2")+
  scale_fill_manual(
    values = c("level41_basin1"=alpha("#9ecae1",0.7),
               "level41_basin2"=alpha("#DC0000FF",0.7),
               "level41_basin3"=alpha("#4DBBD5FF",0.7),
               "level41_basin4"=alpha("#00A087FF",0.7),
               "level41_basin5"=alpha("#08519c",0.7),
               "level41_basin6"=alpha("#7E6148FF",0.7),
               "level41_basin7"=alpha("#F39B7FFF",0.7)),
    breaks = c("level41_basin1",
               "level41_basin2",
               "level41_basin3",
               "level41_basin4",
               "level41_basin5",
               "level41_basin6",
               "level41_basin7"))

dev.off()

#level42
#layout <- as.data.frame(TSNE_result$Y)
layout <- phate.GSE75748object$embedding%>%as.data.frame()
basins <- character(length = ncol(data))
for (i in 1:length(basins)) {
  indexi <- subset(sankeyResult_GSE75748,sankeyResult_GSE75748[,1]==paste('index_basin',i,sep = ""))
  basins[i] <- paste(unique(indexi[,4])%>%sort(), collapse = '+')
}
# level <- 42
# for (i in 1:length(MarkovHC_GSE75748$hierarchicalStructure[[level]]$attractorPoints)) {
#   basins[MarkovHC_GSE75748$hierarchicalStructure[[level]]$attractorPoints[[i]]] <- "attractors"
# }
layout$basins <- basins
pdf(file = './level42.pdf',width = 3.5, height = 3.5)
ggplot(data=layout, mapping =  aes(x=PHATE1, y=PHATE2)) +
  geom_point(size=1, shape=21, aes(fill=basins), color=alpha("#525252",0))+
  xlim(min(layout$PHATE1)-1,max(layout$PHATE1)+1)+
  ylim(min(layout$PHATE2)-1,max(layout$PHATE2)+1)+
  mytheme+ggtitle("level 42")+ guides(fill=FALSE) +
  xlab("PHATE1") + ylab("PHATE2")+
  scale_fill_manual(
    values = c("level42_basin1"=alpha('#DC0000FF',0.7),
               "level42_basin2"=alpha('#4DBBD5FF',0.7),
               "level42_basin3"=alpha('#00A087FF',0.7),
               "level42_basin4"=alpha('#08519c',0.7),
               "level42_basin5"=alpha('#7E6148FF',0.7),
               "level42_basin6"=alpha('#F39B7FFF',0.7)),
    breaks = c("level42_basin1",
               "level42_basin2",
               "level42_basin3",
               "level42_basin4",
               "level42_basin5",
               "level42_basin6"))

dev.off()


centrality_scores <- MarkovHC_GSE75748$midResults$centrality_scores
pdf(file = './centrality_scores.pdf', width = 3.5, height = 3.5)
ggplot(data=layout, mapping =  aes(x=PHATE1, y=PHATE2, color=centrality_scores)) +
  scale_color_gradient2(midpoint=38, 
                        low="#053061", mid="#fb6a4a",high="#b2182b", space ="Lab",guide=FALSE)+
  geom_point(size=1, shape=19)+
  xlim(min(layout$PHATE1)-1,max(layout$PHATE1)+1)+
  ylim(min(layout$PHATE2)-1,max(layout$PHATE2)+1)+
  mytheme+
  xlab("PHATE1") + ylab("PHATE2")
dev.off()


#heatmap
#Find differentially expressed genes
Idents(object = GSE75748object) <- sankeyResult_GSE75748$level40

GSE75748object.markers <- FindAllMarkers(GSE75748object,
                                         min.pct = 0.25,
                                         logfc.threshold = 0.25,
                                         only.pos=TRUE)
GSE75748object.markerstop50 <- GSE75748object.markers %>% group_by(cluster) %>% top_n(n = 50, wt = avg_logFC)


GSE75748object.markerstop50$cluster <- plyr::mapvalues(GSE75748object.markerstop50$cluster, 
                                                 from=c("level40_basin6",
                                                        "level40_basin7",
                                                        "level40_basin1",
                                                        "level40_basin5",
                                                        "level40_basin3",
                                                        "level40_basin8",
                                                        "level40_basin4",
                                                        "level40_basin2"),
                                                 to=c('basin1',
                                                      'basin2',
                                                      'basin3',
                                                      'basin4',
                                                      'basin5',
                                                      'basin6',
                                                      'basin7',
                                                      'basin8'))
GSE75748object.markerstop50$cluster <- factor(GSE75748object.markerstop50$cluster, levels = c('basin1',
                                                                                              'basin2',
                                                                                              'basin3',
                                                                                              'basin4',
                                                                                              'basin5',
                                                                                              'basin6',
                                                                                              'basin7',
                                                                                              'basin8'))
GSE75748object.markerstop50 <- GSE75748object.markerstop50[order(GSE75748object.markerstop50$cluster, decreasing = FALSE),]
write.table(GSE75748object.markerstop50, file = './GSE75748/markerGenes.txt', quote = FALSE, sep=' ', row.names = F)
#GSE75748object.markers <- GSE75748object.markers[order(GSE75748object.markers[,2], decreasing = T),]
sankeyResult_GSE75748 <- sankeyResult(MarkovObject = MarkovHC_GSE75748,
                                      MarkovLevels = 40:43)
for (i in 1:ncol(sankeyResult_GSE75748)) {
  sankeyResult_GSE75748[,i] <- paste(colnames(sankeyResult_GSE75748)[i],
                                      sankeyResult_GSE75748[,i],
                                      sep = '_basin')
}
sankeyResult_GSE75748$Freq <- rep(1,nrow(sankeyResult_GSE75748))
head(sankeyResult_GSE75748)

ordergenes_expression_matrix <- GetAssayData(object = GSE75748object, slot = "scale.data")
GSE75748object.markerstop50 <- GSE75748object.markerstop50[order(factor(GSE75748object.markerstop50$cluster, levels = c("level40_basin6",
                                                                                                                        "level40_basin7",
                                                                                                                        "level40_basin1",
                                                                                                                        "level40_basin5",
                                                                                                                        "level40_basin3",
                                                                                                                        "level40_basin8",
                                                                                                                        "level40_basin4",
                                                                                                                        "level40_basin2"))),]
ordergenes_expression_matrix <- subset(ordergenes_expression_matrix, rownames(ordergenes_expression_matrix)%in%GSE75748object.markerstop50$gene)
ordergenes_expression_matrix <- ordergenes_expression_matrix[order(factor(rownames(ordergenes_expression_matrix), levels = unique(GSE75748object.markerstop50$gene))),]

celltypecahracter <- as.character(GSE75748object@meta.data$cellTypes)
for (i in 1:length(celltypecahracter)) {
  celltypecahracter[i] <- str_replace_all(celltypecahracter[i], " ", "_")
  celltypecahracter[i] <- str_replace_all(celltypecahracter[i], "-", "_")
}

annotation_col_C_andcluster = data.frame(cellTypes=factor(celltypecahracter),
                                         Basins=factor(sankeyResult_GSE75748$level40))
rownames(annotation_col_C_andcluster) = colnames(ordergenes_expression_matrix)
ann_colors_C = list(
  cellTypes =c(H1_ES_cell=alpha("#7E6148FF",0.7),
               H9_ES_cell=alpha("#7E6148FF",0.7),
               definitive_endoderm_cell=alpha("#4DBBD5FF",0.7),
               endothelial_cell=alpha("#F39B7FFF",0.7),
               human_foreskin_fibroblast=alpha("#DC0000FF",0.7),
               neuronal_progenitor_cell=alpha("#08519c",0.7),
               trophoblast_like_cell=alpha("#00A087FF",0.7)),
  Basins = c(level40_basin1=alpha("#9ecae1",0.7),
             level40_basin2=alpha("#DC0000FF",0.7),
             level40_basin3=alpha("#4DBBD5FF",0.7),
             level40_basin4=alpha("#00A087FF",0.7),
             level40_basin5=alpha("#08519c",0.7),
             level40_basin6=alpha("#7E6148FF",0.7),
             level40_basin7=alpha("#C6A87F",0.7),
             level40_basin8=alpha("#F39B7FFF",0.7)))



unique_combine_basin <- c("level40_basin6",
                          "level40_basin7",
                          "level40_basin1",
                          "level40_basin5",
                          "level40_basin3",
                          "level40_basin8",
                          "level40_basin4",
                          "level40_basin2")
ordergenes_expression_matrix <- t(ordergenes_expression_matrix)
ordered_genes_expression_matrix <- subset(ordergenes_expression_matrix, sankeyResult_GSE75748$level40%in%unique_combine_basin[1])
for (i in 2:length(unique_combine_basin)) {
  subcluster <- subset(ordergenes_expression_matrix, sankeyResult_GSE75748$level40%in%unique_combine_basin[i])
  ordered_genes_expression_matrix <- rbind(ordered_genes_expression_matrix, subcluster)
}
ordered_genes_expression_matrix <- t(ordered_genes_expression_matrix)

ordered_genes_expression_matrix_copy <- ordered_genes_expression_matrix

range(ordered_genes_expression_matrix)
ordered_genes_expression_matrix[ordered_genes_expression_matrix>4] <- 4
ordered_genes_expression_matrix[ordered_genes_expression_matrix<(-4)] <- (-4)
pheatmap(as.matrix(ordered_genes_expression_matrix), cluster_rows = F, cluster_cols =F,
         scale = "none" ,
         legend_breaks= ceiling(seq(min(ordered_genes_expression_matrix),
                                    max(ordered_genes_expression_matrix),0.01)),
         color = colorRampPalette(colors = c("#377eb8","#deebf7","#e41a1c"))(length(seq(min(ordered_genes_expression_matrix),max(ordered_genes_expression_matrix),0.01))),
         breaks= seq(min(ordered_genes_expression_matrix),
                     max(ordered_genes_expression_matrix),
                     by=0.01),
         show_colnames = F, show_rownames = F,
         annotation_col  = annotation_col_C_andcluster,
         annotation_colors = ann_colors_C,
         fontsize =15,
         width = 15,
         height = 10, 
         filename = './heatmap.pdf')

#select genes
ordered_genes_expression_matrix <- subset(ordered_genes_expression_matrix, rownames(ordered_genes_expression_matrix)%in%genelist[,1])
set.seed(1)

ordered_genes_expression_matrix <- ordered_genes_expression_matrix[order(factor(rownames(ordered_genes_expression_matrix), 
                                                                                levels = c("DNMT3B",
                                                                                           "NANOG",
                                                                                           "PMAIP1",
                                                                                           "ZFP42",
                                                                                           "LECT1",
                                                                                           
                                                                                           "PAX3",
                                                                                           "MAP2",
                                                                                           "ZFHX4",
                                                                                           "PAX6",
                                                                                           "MAPK10",
                                                                                           "DLK1",
                                                                                           
                                                                                           "EOMES",
                                                                                           "CER1",
                                                                                           "ERBB4",
                                                                                           "LEFTY2",
                                                                                           "LEFTY1",
                                                                                           "LHX1",
                                                                                           "CXCR4",
                                                                                           "NODAL",
                                                                                           "MYCT1",
                                                                                           "GDF3",

                                                                                           "CD34",
                                                                                           "HAPLN1",
                                                                                           "IFI16",
                                                                                           "PECAM1",
                                                                                           "GNG11",
                                                                                           "TNFSF10",
                                                                                           
                                                                                           "PAPPA2",
                                                                                           "TRIM55",
                                                                                           "MTUS2",
                                                                                           "GABRP",
                                                                                           "VTCN1",
                                                                                           "EPAS1",
                                                                                           "IGFBP3"
                                                                                          ))),]
#range(ordered_genes_expression_matrix)
ordered_genes_expression_matrix[ordered_genes_expression_matrix>1] <- 1
ordered_genes_expression_matrix[ordered_genes_expression_matrix< (-1)] <- (-1)
pheatmap(as.matrix(ordered_genes_expression_matrix), cluster_rows = F, cluster_cols =F,
         scale = "none" ,
         legend_breaks= ceiling(seq(min(ordered_genes_expression_matrix),
                                    max(ordered_genes_expression_matrix),0.01)),
         color = colorRampPalette(colors = c("#377eb8","#deebf7","#e41a1c"))(length(seq(min(ordered_genes_expression_matrix),max(ordered_genes_expression_matrix),0.01))),
         breaks= seq(min(ordered_genes_expression_matrix),
                     max(ordered_genes_expression_matrix),
                     by=0.01),
         show_colnames = F, show_rownames = T,
         annotation_col  = annotation_col_C_andcluster,
         annotation_colors = ann_colors_C,
         fontsize =15,
         width = 15,height = 10, filename = './selectGenesHeatmap.pdf')


#Differentially expressed genes in H1 and H9 subtypes
H1_ES_cell_object <- subset(x = GSE75748object, cellTypes=='H1 ES cell')
H9_ES_cell_object <- subset(x = GSE75748object, cellTypes=='H9 ES cell')
H1_ES_cell_object.markers <- FindMarkers(H1_ES_cell_object,
                                         ident.1='level40_basin6',
                                         ident.2='level40_basin7',
                                         min.pct = 0.25,
                                         logfc.threshold = 0.25,
                                         only.pos=FALSE)

H9_ES_cell_object.markers <- FindMarkers(H9_ES_cell_object,
                                         ident.1='level40_basin6',
                                         ident.2='level40_basin7',
                                         min.pct = 0.25,
                                         logfc.threshold = 0.25,
                                         only.pos=FALSE)

basin6and7_object.markers <- FindMarkers(GSE75748object,
                                         ident.1='level40_basin6',
                                         ident.2='level40_basin7',
                                         min.pct = 0.25,
                                         logfc.threshold = 0.25,
                                         only.pos=FALSE)
basin6and7_object.markers <- basin6and7_object.markers[order(basin6and7_object.markers$avg_logFC),]

GO_basin6and7_object.markers <- enrichGO(gene = rownames(basin6and7_object.markers)%>%str_to_lower()%>%str_to_title(),
                                         keyType = "SYMBOL",
                                         OrgDb = 'org.Mm.eg.db',
                                         ont = "BP",
                                         pAdjustMethod = "fdr",
                                         pvalueCutoff = 0.05,
                                         qvalueCutoff  = 0.2,
                                         minGSSize = 3,
                                         maxGSSize = 500,
                                         readable = FALSE)
#select basin6 and 7
ordergenes_expression_matrix <- GetAssayData(object = GSE75748object, slot = "scale.data")
ordered_genes_expression_matrix <- subset(ordergenes_expression_matrix, rownames(ordergenes_expression_matrix)%in%rownames(basin6and7_object.markers))
ordered_genes_expression_matrix <- t(ordered_genes_expression_matrix)
ordered_genes_expression_matrix_6 <- subset(ordered_genes_expression_matrix, Idents(GSE75748object)%in%c('level40_basin6'))
ordered_genes_expression_matrix_7 <- subset(ordered_genes_expression_matrix, Idents(GSE75748object)%in%c('level40_basin7'))
ordered_genes_expression_matrix <- rbind(ordered_genes_expression_matrix_6,ordered_genes_expression_matrix_7)
ordered_genes_expression_matrix <- t(ordered_genes_expression_matrix)
ordered_genes_expression_matrix <- ordered_genes_expression_matrix[order(factor(rownames(ordered_genes_expression_matrix), levels = rownames(basin6and7_object.markers))),]
range(ordered_genes_expression_matrix)
ordered_genes_expression_matrix[ordered_genes_expression_matrix>2] <- 2
ordered_genes_expression_matrix[ordered_genes_expression_matrix<(-2)] <- (-2) 
pheatmap(as.matrix(ordered_genes_expression_matrix), cluster_rows = F, cluster_cols =F,
         scale = "none" ,
         legend_breaks= ceiling(seq(min(ordered_genes_expression_matrix),
                                    max(ordered_genes_expression_matrix),0.01)),
         color = colorRampPalette(colors = c("#377eb8","#deebf7","#e41a1c"))(length(seq(min(ordered_genes_expression_matrix),max(ordered_genes_expression_matrix),0.01))),
         breaks= seq(min(ordered_genes_expression_matrix),
                     max(ordered_genes_expression_matrix),
                     by=0.01),
         show_colnames = F, show_rownames = T,
         annotation_col  = annotation_col_C_andcluster,
         annotation_colors = ann_colors_C,treeheight_row=0,
         fontsize =15,
         width = 15,height = 10, filename = './selectbasin6and7Heatmap.pdf')

GO_diffGenes <- enrichGO(gene = rownames(H1_ES_cell_object.markers)%>%str_to_lower()%>%str_to_title(),
                         keyType = "SYMBOL",
                         OrgDb = 'org.Mm.eg.db',
                         ont = "BP",
                         pAdjustMethod = "fdr",
                         pvalueCutoff = 0.05,
                         qvalueCutoff  = 0.2,
                         minGSSize = 3,
                         maxGSSize = 500,
                         readable = FALSE)
pdf('./basin67enrichment.pdf')
enrichplot::dotplot(GO_basin6and7_object.markers,
                    x="count",
                    color="qvalue",
                    showCategory=10,
                    font.size=25,
                    title='')+scale_y_discrete(labels=function(x) str_wrap(x, width=40))+
  theme(
    axis.line = element_line(size = 1,
                             colour = "black"),
    axis.title.x =element_text(size=15),
    axis.text.x = element_text(size = 20,
                               family = "sans",
                               color = "black",
                               face = "bold",
                               vjust = 0,
                               hjust = 0),
    axis.text.y = element_text(size = 15,
                               family = "sans",
                               color = "black",
                               face = "bold",
                               vjust = 0,
                               hjust = 1),
    axis.title.y=element_text(size=15,
                              family = "sans",
                              color = "black",
                              face = "bold"),
    legend.text = element_text(size=15,
                               family = "sans",
                               color = "black",
                               face = "bold"),
    legend.title = element_text(size=15,
                                family = "sans",
                                color = "black",
                                face = "bold"))
dev.off()
GO_basin6and7_object.markers.result <- as.data.frame(GO_basin6and7_object.markers@result)
GO_basin6and7_object.markers.result <- GO_basin6and7_object.markers.result[order(GO_basin6and7_object.markers.result[,9], decreasing = TRUE),]
head(GO_basin6and7_object.markers.result)

GO_diffGenes.result <- as.data.frame(GO_diffGenes@result)
GO_diffGenes.result <- GO_diffGenes.result[order(GO_diffGenes.result[,9], decreasing = TRUE),]
head(GO_diffGenes.result)

#
basins <- character(length = ncol(data))
for (i in 1:length(basins)) {
  indexi <- subset(sankeyResult_GSE75748,sankeyResult_GSE75748[,1]==paste('index_basin',i,sep = ""))
  basins[i] <- paste(unique(indexi[,2])%>%sort(), collapse = '+')
}
basins <- as.data.frame(basins)
basins$basins <- as.character(basins$basins)
basins$cellTypes <- GSE75748object@meta.data$cellTypes
basins <- basins[which((basins$basins)%in%c('level40_basin6','level40_basin7')),]
basins$cellcount <- 1
pdf('./ESbar.pdf', width = 3.5, height = 3.5)
ggplot(basins,aes(cellTypes,cellcount,fill=basins))+
  geom_bar(stat="identity",position="stack")+
  ggtitle("")+scale_fill_manual(values = c(level40_basin6=alpha("#7E6148FF",0.7),
                                  level40_basin7=alpha("#C6A87F",0.7)))+
  mytheme+ guides(fill=FALSE)
dev.off()

#heatmap of differentially expressed genes of basins in H1 and H9
ordered_genes_expression_matrix <- subset(ordered_genes_expression_matrix_copy, rownames(ordered_genes_expression_matrix_copy)%in%rownames(H9_ES_cell_object.markers))
pheatmap(as.matrix(ordered_genes_expression_matrix), cluster_rows = T, cluster_cols =F,
         scale = "row" ,
         legend_breaks= ceiling(seq(min(ordered_genes_expression_matrix)-3,
                                    max(ordered_genes_expression_matrix)-3,0.01)),
         color = colorRampPalette(colors = c("#377eb8","#deebf7","#e41a1c"))(length(seq(min(ordered_genes_expression_matrix)-3,max(ordered_genes_expression_matrix)-3,0.01))),
         breaks= seq(min(ordered_genes_expression_matrix)-3,
                     max(ordered_genes_expression_matrix)-3,
                     by=0.01),
         show_colnames = F, show_rownames = T,
         annotation_col  = annotation_col_C_andcluster,
         annotation_colors = ann_colors_C,
         fontsize =15,
         width = 15,height = 10, filename = './H9.Heatmap.pdf')

save.image('./GSE75748/GSE75748.RData')

#tree
#plot the tree
pdf(file= './treeuseFunction.pdf', width = 15, height = 10)
plotHierarchicalStructure(MarkovObject=MarkovHC_GSE75748,
                          MarkovLevels=40:43,
                          colorVector=c(alpha("#9ecae1",0.7),alpha("#DC0000FF",0.7),alpha("#4DBBD5FF",0.7),alpha("#00A087FF",0.7),
                                        alpha("#08519c",0.7),alpha("#7E6148FF",0.7),alpha("#C6A87F",0.7),alpha("#F39B7FFF",0.7)))
dev.off()


#heatmap
ordergenes_expression_matrix <- data
celltypecahracter <- as.character(reallabel[,2])
for (i in 1:length(celltypecahracter)) {
  celltypecahracter[i] <- str_replace_all(celltypecahracter[i], " ", "_")
  celltypecahracter[i] <- str_replace_all(celltypecahracter[i], "-", "_")
}

annotation_col_C_andcluster = data.frame(CellType=factor(celltypecahracter),
                                         Basins=factor(sankeyResult_GSE75748[,4]))
rownames(annotation_col_C_andcluster) = colnames(ordergenes_expression_matrix)
ann_colors_C = list(
  CellType = c(H1_ES_cell="#ffd92f",
               H9_ES_cell="#fc8d62",
               definitive_endoderm_cell="#8da0cb",
               endothelial_cell="#e78ac3",
               human_foreskin_fibroblast="#a6d854",
               neuronal_progenitor_cell="#66c2a5",
               trophoblast_like_cell="#1f78b4"),
  Basins = c(level14_basin1="#a6d854",
             level14_basin2="#ffd92f",
             level14_basin3="#66c2a5",
             level14_basin4="#e78ac3",
             level14_basin5="#8da0cb",
             level14_basin6="#1f78b4",
             level14_basin7="#fc8d62"))

unique_combine_basin <- c("level14_basin2",
                          "level14_basin7",
                          "level14_basin5",
                          "level14_basin4",
                          "level14_basin3",
                          "level14_basin1",
                          "level14_basin6")
ordergenes_expression_matrix <- t(ordergenes_expression_matrix)
ordered_genes_expression_matrix <- subset(ordergenes_expression_matrix, sankeyResult_GSE75748[,4]%in%unique_combine_basin[1])
for (i in 2:length(unique_combine_basin)) {
  subcluster <- subset(ordergenes_expression_matrix, sankeyResult_GSE75748[,4]%in%unique_combine_basin[i])
  ordered_genes_expression_matrix <- rbind(ordered_genes_expression_matrix, subcluster)
}
ordered_genes_expression_matrix <- t(ordered_genes_expression_matrix)

ordered_genes_expression_matrix_copy

log_ordered_genes_expression_matrix <- log(ordered_genes_expression_matrix+1)
log_ordered_genes_expression_matrix[log_ordered_genes_expression_matrix>4] <- 4
ordered_genes_expression_matrix <- log_ordered_genes_expression_matrix


pheatmap(as.matrix(ordered_genes_expression_matrix), cluster_rows = T, cluster_cols =F,
               scale = "row" ,
               legend_breaks= ceiling(seq(min(ordered_genes_expression_matrix)-4,max(ordered_genes_expression_matrix),0.01)),
               color = colorRampPalette(colors = c("#377eb8","#deebf7","#e41a1c"))(length(seq(min(ordered_genes_expression_matrix)-4,max(ordered_genes_expression_matrix),0.01))),
               breaks= seq(min(ordered_genes_expression_matrix)-4,
                           max(ordered_genes_expression_matrix),
                           by=0.01),
               show_colnames = F, show_rownames = T,
               annotation_col  = annotation_col_C_andcluster,
               annotation_colors = ann_colors_C,
               fontsize =15)

#The sequence of C_cut
pdf(file = './C_cut_seq_whole.pdf', width = 3.5, height = 3.5)
ggplot(C_cut_seq, aes(x=level, y=C_cut_seq))+ geom_point(size=1,shape=19)+mytheme
dev.off()
```

# attractor


```R
head(sankeyResult_GSE75748)
basins <- character(length = ncol(data))
for (i in 1:length(basins)) {
  indexi <- subset(sankeyResult_GSE75748,sankeyResult_GSE75748[,1]==paste('index_basin',i,sep = ""))
  basins[i] <- paste(unique(indexi[,4])%>%sort(), collapse = '+')
}
Idents(GSE75748object) <- basins
GSE75748_counts <- GetAssayData(object = GSE75748object, slot = "counts")%>%as.matrix()
attractorAndbasinIndex <- rep('basin',nrow(MarkovHC_GSE75748$midResults$symmetric_KNN_graph))
for (i in 1:length(MarkovHC_GSE75748$hierarchicalStructure[[42]]$attractorPoints)) {
  attractorAndbasinIndex[MarkovHC_GSE75748$hierarchicalStructure[[42]]$attractorPoints[[i]]] <- "attractors"
}
Idents(GSE75748object) <- paste(Idents(GSE75748object),attractorAndbasinIndex,sep = '_')

GSE75748_counts <- t(GSE75748_counts)
spearman <- list()
for (i in 1:6) {
  attractor_temp <- subset(GSE75748_counts, Idents(GSE75748object)==paste('level42_basin',as.character(i),'_attractors',
                                                                          sep=''))
  attractor_temp <- t(attractor_temp)
  attractor_cor <- cor(x=attractor_temp, y=NULL, method='spearman')
  attractor_cor <- attractor_cor[upper.tri(attractor_cor)]
  
  basin_temp <- subset(GSE75748_counts, Idents(GSE75748object)==paste('level42_basin',as.character(i),'_basin',
                                                                          sep=''))
  basin_temp <- t(basin_temp)
  basin_cor <- cor(x=basin_temp, y=NULL, method='spearman')
  basin_cor <- basin_cor[upper.tri(basin_cor)]
  basin_cor <- basin_cor[sample(1:length(basin_cor), size=length(attractor_cor))]
  
  spearman[[i]] <- list(attractor_cor, basin_cor)
}

spearmanVector <- c()
AorB <- c()
BasinVector <- c()
for(i in 1:6){
  spearmanVector <- c(spearmanVector, spearman[[i]][[1]])
  spearmanVector <- c(spearmanVector, spearman[[i]][[2]])
  AorB <- c(AorB, rep('attractor',length(spearman[[i]][[1]])))
  AorB <- c(AorB, rep('basin',length(spearman[[i]][[2]])))
  BasinVector <- c(BasinVector, rep(paste('basin',as.character(i),sep=''),2*length(spearman[[i]][[1]])))
}
spearmanDataframe <- data.frame(spearmanVector)
spearmanDataframe$AorB <- AorB
spearmanDataframe$BasinVector <- BasinVector

pdf(file = './Figure.AandBCor.pdf')
ggplot(data=spearmanDataframe, aes(x=BasinVector, y=spearmanVector, fill=AorB, shape=AorB), color='black')+
  stat_boxplot(geom ='errorbar', width = 0.6,position =position_dodge(0.8))+
  scale_shape_manual(values = c(21,23))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(0.8))+
  geom_jitter(size=1, position=position_dodge(0.8),aes(fill=AorB))+
  scale_fill_manual(values = c(attractor=alpha('#e41a1c',0.7),basin=alpha('#377eb8',0.7)))+
  xlab(label='basins')+ylab(label='spearman correlation')+
  stat_compare_means(aes(group=AorB), method = 'wilcox.test', label = "p.signif")+
  ylim(0.5,1)+
  theme(panel.grid.major =element_blank(),
        text = element_text(size = 20,
                            family = "sans",
                            color = "black",
                            face = "bold"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(size = 1,
                                 colour = "black"),
        axis.title.x =element_text(size = 20,
                                   family = "sans",
                                   color = "black",
                                   face = "bold"),
        axis.text.x = element_text(size = 20,
                                   family = "sans",
                                   color = "black",
                                   face = "bold",
                                   vjust = 1,
                                   hjust = 1,
                                   angle = 45),
        axis.text.y = element_text(size = 20,
                                   family = "sans",
                                   color = "black",
                                   face = "bold",
                                   vjust = 0,
                                   hjust = 1),
        axis.title.y=element_text(size=20,
                                  family = "sans",
                                  color = "black",
                                  face = "bold"),
        legend.text = element_text(size=15,
                                   family = "sans",
                                   color = "black",
                                   face = "bold"),
        legend.title = element_blank())
dev.off()

save.image('./GSE75748/GSE75748Cor.RData')
```

# neuronprogeniter


```R
unique(GSE75748object@meta.data$cellTypes)

neuronal_progenitor_cell <- subset(x = GSE75748object, cellTypes=="neuronal progenitor cell")
neuronal_progenitor_cell.markers <- FindMarkers(neuronal_progenitor_cell,
                                         ident.1='level40_basin1',
                                         ident.2='level40_basin5',
                                         min.pct = 0.25,
                                         logfc.threshold = 0.5,
                                         only.pos=FALSE)
neuronal_progenitor_cell.markers <- neuronal_progenitor_cell.markers[order(neuronal_progenitor_cell.markers$avg_logFC, decreasing = T),]
neuronal_progenitor_cell_matrix <- GetAssayData(object = neuronal_progenitor_cell, slot = "scale.data")
#分成上调和下调两组分别做GO
up_genes <- rownames(subset(neuronal_progenitor_cell.markers, (neuronal_progenitor_cell.markers$avg_logFC)>0))
down_genes <- rownames(subset(neuronal_progenitor_cell.markers, (neuronal_progenitor_cell.markers$avg_logFC)<0))
up_GO_neuronal_progenitor_cell.markers <- enrichGO(gene = up_genes%>%str_to_lower()%>%str_to_title(),
                                         keyType = "SYMBOL",
                                         OrgDb = 'org.Mm.eg.db',
                                         ont = "BP",
                                         pAdjustMethod = "fdr",
                                         pvalueCutoff = 0.05,
                                         qvalueCutoff  = 0.2,
                                         minGSSize = 3,
                                         maxGSSize = 500,
                                         readable = FALSE)
down_GO_neuronal_progenitor_cell.markers <- enrichGO(gene = down_genes%>%str_to_lower()%>%str_to_title(),
                                                   keyType = "SYMBOL",
                                                   OrgDb = 'org.Mm.eg.db',
                                                   ont = "BP",
                                                   pAdjustMethod = "fdr",
                                                   pvalueCutoff = 0.05,
                                                   qvalueCutoff  = 0.2,
                                                   minGSSize = 3,
                                                   maxGSSize = 500,
                                                   readable = FALSE)

pdf('./neuronupenrichment.pdf')
enrichplot::dotplot(up_GO_neuronal_progenitor_cell.markers,
                    x="count",
                    color="qvalue",
                    showCategory=10,
                    font.size=5,
                    title='')+scale_y_discrete(labels=function(x) str_wrap(x, width=40))+
  theme(#panel.grid.major =element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(size = 1,
                             colour = "black"),
    axis.title.x =element_text(size=5),
    axis.text.x = element_text(size = 20,
                               family = "sans",
                               color = "black",
                               face = "bold",
                               vjust = 0,
                               hjust = 0),
    axis.text.y = element_text(size = 5,
                               family = "sans",
                               color = "black",
                               face = "bold",
                               vjust = 0,
                               hjust = 1),
    axis.title.y=element_text(size=5,
                              family = "sans",
                              color = "black",
                              face = "bold"),
    legend.text = element_text(size=5,
                               family = "sans",
                               color = "black",
                               face = "bold"),
    legend.title = element_text(size=5,
                                family = "sans",
                                color = "black",
                                face = "bold"))
dev.off()

pdf('./neurondownenrichment.pdf')
enrichplot::dotplot(down_GO_neuronal_progenitor_cell.markers,
                    x="count",
                    color="qvalue",
                    showCategory=10,
                    font.size=5,
                    title='')+scale_y_discrete(labels=function(x) str_wrap(x, width=40))+
  theme(#panel.grid.major =element_blank(),
    #panel.grid.minor = element_blank(),
    #panel.background = element_blank(),
    axis.line = element_line(size = 1,
                             colour = "black"),
    axis.title.x =element_text(size=5),
    axis.text.x = element_text(size = 20,
                               family = "sans",
                               color = "black",
                               face = "bold",
                               vjust = 0,
                               hjust = 0),
    axis.text.y = element_text(size = 5,
                               family = "sans",
                               color = "black",
                               face = "bold",
                               vjust = 0,
                               hjust = 1),
    axis.title.y=element_text(size=5,
                              family = "sans",
                              color = "black",
                              face = "bold"),
    legend.text = element_text(size=5,
                               family = "sans",
                               color = "black",
                               face = "bold"),
    legend.title = element_text(size=5,
                                family = "sans",
                                color = "black",
                                face = "bold"))
dev.off()

#
ordergenes_expression_matrix <- GetAssayData(object = neuronal_progenitor_cell, slot = "scale.data")
ordered_genes_expression_matrix <- subset(ordergenes_expression_matrix, 
                                          rownames(ordergenes_expression_matrix)%in%rownames(neuronal_progenitor_cell.markers))
ordered_genes_expression_matrix <- t(ordered_genes_expression_matrix)
ordered_genes_expression_matrix_1 <- subset(ordered_genes_expression_matrix, Idents(neuronal_progenitor_cell)%in%c('level40_basin1'))
ordered_genes_expression_matrix_5 <- subset(ordered_genes_expression_matrix, Idents(neuronal_progenitor_cell)%in%c('level40_basin5'))
ordered_genes_expression_matrix <- rbind(ordered_genes_expression_matrix_1,ordered_genes_expression_matrix_5)
ordered_genes_expression_matrix <- t(ordered_genes_expression_matrix)
ordered_genes_expression_matrix <- ordered_genes_expression_matrix[order(factor(rownames(ordered_genes_expression_matrix), levels = rownames(neuronal_progenitor_cell.markers))),]
range(ordered_genes_expression_matrix)
ordered_genes_expression_matrix[ordered_genes_expression_matrix>2] <- 2
ordered_genes_expression_matrix[ordered_genes_expression_matrix<(-2)] <- (-2) 
celltypecahracter <- as.character(neuronal_progenitor_cell@meta.data$cellTypes)
for (i in 1:length(celltypecahracter)) {
  celltypecahracter[i] <- str_replace_all(celltypecahracter[i], " ", "_")
  celltypecahracter[i] <- str_replace_all(celltypecahracter[i], "-", "_")
}
annotation_col_C_andcluster = data.frame(cellTypes=factor(celltypecahracter),
                                         Basins=factor(Idents(neuronal_progenitor_cell)))
rownames(annotation_col_C_andcluster) = colnames(ordergenes_expression_matrix)
ann_colors_C = list(
  cellTypes =c(#H1_ES_cell=alpha("#7E6148FF",0.7),
               #H9_ES_cell=alpha("#7E6148FF",0.7),
               #definitive_endoderm_cell=alpha("#4DBBD5FF",0.7),
               #endothelial_cell=alpha("#F39B7FFF",0.7),
               #human_foreskin_fibroblast=alpha("#DC0000FF",0.7),
               neuronal_progenitor_cell=alpha("#08519c",0.7)
               #trophoblast_like_cell=alpha("#00A087FF",0.7)
               ),
  Basins = c(level40_basin1=alpha("#9ecae1",0.7),
             #level40_basin2=alpha("#DC0000FF",0.7),
             #level40_basin3=alpha("#4DBBD5FF",0.7),
             #level40_basin4=alpha("#00A087FF",0.7),
             level40_basin5=alpha("#08519c",0.7)
             #level40_basin6=alpha("#7E6148FF",0.7),
             #level40_basin7=alpha("#C6A87F",0.7),
             #level40_basin8=alpha("#F39B7FFF",0.7)
             ))

pheatmap(as.matrix(ordered_genes_expression_matrix), cluster_rows = F, cluster_cols =F,
         scale = "none" ,
         legend_breaks= ceiling(seq(min(ordered_genes_expression_matrix),
          
                                                              max(ordered_genes_expression_matrix),0.01)),
         color = colorRampPalette(colors = c("#377eb8","#deebf7","#e41a1c"))(length(seq(min(ordered_genes_expression_matrix),max(ordered_genes_expression_matrix),0.01))),
         breaks= seq(min(ordered_genes_expression_matrix),
                     max(ordered_genes_expression_matrix),
                     by=0.01),
         show_colnames = F, show_rownames = T,
         annotation_col  = annotation_col_C_andcluster,
         annotation_colors = ann_colors_C,
         treeheight_row=0,
         fontsize =10,
         width = 15,
         height = 10, 
         filename = './selectneuronprogeniterHeatmap.pdf')
```
